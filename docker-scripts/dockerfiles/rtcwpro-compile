FROM ubuntu:22.04

ARG BRANCH
ENV BRANCH=${BRANCH}

ENV DEBIAN_FRONTEND noninteractive
RUN dpkg --add-architecture i386 && \
    apt-get update && \
    apt-get -y upgrade && \
    apt-get install -y wget libc6:i386 zip unzip git gdb-multiarch gcc cmake perl curl gcc-multilib autoconf libtool nasm mingw-w64 g++

RUN useradd -ms /bin/bash compile

RUN mkdir /output
RUN chown compile:compile /output

USER compile
WORKDIR /home/compile

RUN mkdir -p /home/compile/build && \
    ln -sf /home/compile/mnt/ /home/compile/build 

COPY --chown=compile:compile scripts/make-all.sh /home/compile/start

RUN chmod +x /home/compile/start

RUN bash /home/compile/start ${BRANCH}

RUN mv /home/compile/rtcwpro/build /output/
